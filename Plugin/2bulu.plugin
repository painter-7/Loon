
[mitm]
hostname = helper.2bulu.com

[Script]
# æ•°æ®æ•è·æ¨¡å—
http-request ^https:\/\/helper\.2bulu\.com\/dataSpace\/(claimCapacity|getStorageSpace) script-path=https://raw.githubusercontent.com/painter-7/Loon/main/Plugin/2bulu.plugin,timeout=10,tag=ä¸¤æ­¥è·¯æ•°æ®æ•è·

# æ¯æ—¥å®šæ—¶ä»»åŠ¡
cron "0 9 * * *" script-path=https://raw.githubusercontent.com/painter-7/Loon/main/Plugin/2bulu.plugin,timeout=30,tag=ä¸¤æ­¥è·¯è‡ªåŠ¨ä»»åŠ¡

[Local]
^https?://helper\.2bulu\.com/dataSpace/(claimCapacity|getStorageSpace) url script-response-body
(() => {
  const captureKeys = {
    authCode: $request.url.match(/authCode=([^&]+)/)?.[1],
    userId: $request.url.match(/userId=(\d+)/)?.[1],
    psign: $request.url.match(/psign=([a-f0-9]+)/)?.[1],
    token: ($request.headers['Cookie'] || '').match(/token=([^;]+)/)?.[1]
  };
  
  Object.entries(captureKeys).forEach(([k,v]) => {
    if(v) $persistentStore.write(v, `2bulu_${k}`);
  });
  $done();
})();

const _2bulu = {
  base: "https://helper.2bulu.com/dataSpace/",
  cfg: {
    psign: $persistentStore.read("2bulu_psign"),
    auth: $persistentStore.read("2bulu_authCode"),
    uid: $persistentStore.read("2bulu_userId"),
    token: $persistentStore.read("2bulu_token")
  },
 Â 
  async execute() {
    if (!this.validate()) return;
   Â 
    try {
      const signRes = await this.sign();
      const spaceInfo = await this.space();
      this.notify(signRes, spaceInfo);
    } catch (e) {
      $notification.post("â— æ‰§è¡Œå¼‚å¸¸", e.message, "");
    }
  },

  sign: async () => {
    const res = await $http.post({
      url: `${_2bulu.base}claimCapacity?${_2bulu.query()}`,
      headers: _2bulu.headers()
    });
    if (res.data?.errCode !== "0") throw new Error(`ç­¾åˆ°å¤±è´¥: ${res.data?.errMsg || ''}`);
    return { capacity: this.parseCapacity(res) };
  },
 Â 
  space: async () => {
    const res = await $http.get({
      url: `${_2bulu.base}getStorageSpace?${_2bulu.query()}`,
      headers: _2bulu.headers()
    });
    return this.format(res.data?.data);
  },
 Â 
  query: () => `psign=${_2bulu.cfg.psign}&authCode=${_2bulu.cfg.auth}&userId=${_2bulu.cfg.uid}&p_appVersion=7.8.9`,
 Â 
  headers: () => ({
    "Cookie": `authCode=${_2bulu.cfg.auth}; token=${_2bulu.cfg.token}`,
    "User-Agent": "OutdoorAssistant/7.8.9 (2bulu.plugin)"
  }),
 Â 
  validate: () => [ 'auth', 'uid', 'psign', 'token' ].every(k => _2bulu.cfg[k])Â 
    || $notification.post("ğŸ”‘ å‡­è¯ç¼ºå¤±", "è¯·å…ˆåœ¨APPå®Œæˆä¸€æ¬¡æ‰‹åŠ¨æ“ä½œ", ""),
 Â 
  parseCapacity: (res) => {
    const task = res.data.data?.dataSpaceTaskInfos?.find(t => t.type === 0);
    return task ? `${task.capacity / 1048576}MB` : "å®¹é‡æ•°æ®å¼‚å¸¸";
  },
 Â 
  format: (data) => ({
    total: `${(data.sumCapacity / 1073741824).toFixed(2)}GB`,
    used: `${(data.useCapacity / 1073741824).toFixed(2)}GB`,
    tasks: data.dataSpaceTaskInfos.filter(t => t.status === 0).length
  }),
 Â 
  notify: (sign, space) => {
    $notification.post("ğŸ“¦ äº‘ç©ºé—´æŠ¥å‘Š",Â 
      `æœ¬æ¬¡è·å¾—ï¼š${sign.capacity}\nå­˜å‚¨çŠ¶æ€ï¼š${space.used}å·²ç”¨/${space.total}æ€»é‡`,
      `å¾…é¢†å–ä»»åŠ¡ï¼š${space.tasks}ä¸ª | æ’ä»¶ç‰ˆæœ¬ï¼šv2.0`
    );
  }
};

_2bulu.execute();
