[Plugin]
name = ä¸¤æ­¥è·¯äº‘ç©ºé—´åŠ©æ‰‹
desc = è‡ªåŠ¨ç­¾åˆ°+å®¹é‡ç›‘æ§
author = painter-7
version = 2025.02.25v1

[Script]
# æ•°æ®æ•è·æ¨¡å—
http-request ^https:\/\/helper\.2bulu\.com\/dataSpace\/(claimCapacity|getStorageSpace) script-path=backend_capture.js,timeout=10,enable=true,tag=ä¸¤æ­¥è·¯æ•°æ®æ•è·

# æ¯æ—¥å®šæ—¶ä»»åŠ¡
cron "5 9 * * *" script-path=2bulu.plugin,timeout=30,enable=true,tag=ä¸¤æ­¥è·¯è‡ªåŠ¨ä»»åŠ¡

[Local]
# åå°æ•è·æ¨¡å— (åˆå¹¶åˆ°æ’ä»¶æ–‡ä»¶)
^https?://helper\.2bulu\.com/dataSpace/(claimCapacity|getStorageSpace) url script-response-body
(() => {
  const captureMap = {
    authCode: $request.url.match(/authCode=([^&]+)/)?.[1],
    userId: $request.url.match(/userId=(\d+)/)?.[1],
    psign: $request.url.match(/psign=([a-f0-9]+)/)?.[1],
    token: ($request.headers['Cookie'] || '').match(/token=([^;]+)/)?.[1]
  };

  Object.entries(captureMap).forEach(([k,v]) => {
    if(v) $persistentStore.write(v, `2bulu_${k}`);
  });
  $done();
})();

# ä¸»åŠŸèƒ½æ¨¡å— (åˆå¹¶åˆ°æ’ä»¶æ–‡ä»¶)
const _2bulu = {
  base: "https://helper.2bulu.com/dataSpace/",
  cfg: {
    psign: $persistentStore.read("2bulu_psign"),
    auth: $persistentStore.read("2bulu_authCode"),
    uid: $persistentStore.read("2bulu_userId"),
    token: $persistentStore.read("2bulu_token")
  },

  async run() {
    if (!this.check()) return;
    
    try {
      const signRes = await this.sign();
      const space = await this.space();
      this.notify(signRes, space);
    } catch (e) {
      $notification.post("â— å¼‚å¸¸ä¸­æ–­", e.message, "å»ºè®®æŸ¥çœ‹è°ƒè¯•æ—¥å¿—");
    }
  },

  sign: async () => {
    const res = await $http.post({
      url: `${_2bulu.base}claimCapacity?${_2bulu.query()}`,
      headers: _2bulu.headers()
    });
    if (res.data?.errCode !== "0") throw new Error(`CODE:${res.data?.errCode}`);
    return { capacity: _2bulu.parseCapacity(res) };
  },

  space: async () => {
    const res = await $http.get({
      url: `${_2bulu.base}getStorageSpace?${_2bulu.query()}`,
      headers: _2bulu.headers()
    });
    return _2bulu.format(res.data?.data);
  },

  query: () => `psign=${_2bulu.cfg.psign}&authCode=${_2bulu.cfg.auth}&userId=${_2bulu.cfg.uid}&p_appVersion=7.8.9`,

  headers: () => ({
    "Cookie": `authCode=${_2bulu.cfg.auth}; token=${_2bulu.cfg.token}`,
    "User-Agent": "OutdoorAssistant/7.8.9 (2bulu.plugin)"
  }),

  check: () => [ 'auth', 'uid', 'psign', 'token' ].every(k => _2bulu.cfg[k]) 
    || $notification.post("ğŸ”‘ å‡­è¯ç¼ºå¤±", "è¯·å…ˆåœ¨APPå®Œæˆä¸€æ¬¡æ‰‹åŠ¨æ“ä½œ", ""),

  parseCapacity: (res) => {
    const task = res.data.data?.dataSpaceTaskInfos?.find(t => t.type === 0);
    return task ? `${task.capacity / 1048576}MB` : "å®¹é‡æ•°æ®å¼‚å¸¸";
  },

  format: (data) => ({
    total: `${(data.sumCapacity / 1073741824).toFixed(2)}GB`,
    used: `${(data.useCapacity / 1073741824).toFixed(2)}GB`,
    tasks: data.dataSpaceTaskInfos.filter(t => t.status === 0).length
  }),

  notify: (sign, space) => {
    $notification.post("ğŸ“¦ äº‘ç©ºé—´æŠ¥å‘Š", 
      `æœ¬æ¬¡è·å¾—ï¼š${sign.capacity}\nå­˜å‚¨çŠ¶æ€ï¼š${space.used}å·²ç”¨/${space.total}æ€»é‡`,
      `å¾…é¢†å–ä»»åŠ¡ï¼š${space.tasks}ä¸ª | æ’ä»¶ç‰ˆæœ¬ï¼šv2.0`
    );
  }
};

// æ‰§è¡Œå…¥å£
_2bulu.run();
