[Plugin]
name = ä¸¤æ­¥è·¯äº‘ç©ºé—´åŠ©æ‰‹
desc = è‡ªåŠ¨ç­¾åˆ°+å®¹é‡ç›‘æ§
version = 2.0.1
author = painter-7
minLoonVersion = 3.2.0
icon = https://raw.githubusercontent.com/painter-7/Loon/main/Icon/2bulu.png
updateURL = https://raw.githubusercontent.com/painter-7/Loon/main/Plugin/2bulu.plugin

[mitm]
hostname = helper.2bulu.com

[Script]
http-request ^https:\/\/helper\.2bulu\.com\/dataSpace\/(claimCapacity|getStorageSpace) script-path=https://raw.githubusercontent.com/painter-7/Loon/main/Plugin/2bulu.plugin, timeout=10, tag=ä¸¤æ­¥è·¯æ•°æ®æ•è·

cron "0 9 * * *" script-path=https://raw.githubusercontent.com/painter-7/Loon/main/Plugin/2bulu.plugin, timeout=30, tag=ä¸¤æ­¥è·¯è‡ªåŠ¨ä»»åŠ¡

[Local]
^https?://helper\.2bulu\.com/dataSpace/(claimCapacity|getStorageSpace) url script-response-body

(() => {
  "use strict";
  
  // æ•°æ®æ•è·æ¨¡å—
  const captureKeys = {
    authCode: ($request.url.match(/authCode=([^&]+)/) || [])[1],
    userId: ($request.url.match(/userId=(\d+)/) || [])[1],
    psign: ($request.url.match(/psign=([a-f0-9]+)/) || [])[1],
    token: ($request.headers['Cookie']?.match(/token=([^;]+)/) || [])[1]
  };

  Object.entries(captureKeys).forEach(([key, value]) => {
    if (value) $persistentStore.write(value, `2bulu_${key}`);
  });
  
  $done();
})();

const _2bulu = {
  base: "https://helper.2bulu.com/dataSpace/",
  cfg: {
    psign: $persistentStore.read("2bulu_psign"),
    auth: $persistentStore.read("2bulu_authCode"),
    uid: $persistentStore.read("2bulu_userId"),
    token: $persistentStore.read("2bulu_token")
  },

  async execute() {
    try {
      if (!this.validateCredentials()) return;
      
      const signResult = await this.performSignIn();
      const spaceData = await this.fetchSpaceInfo();
      this.sendNotification(signResult, spaceData);
    } catch (error) {
      $notification.post("â— æ‰§è¡Œå¼‚å¸¸", error.message, "");
    }
  },

  // å‡­è¯éªŒè¯
  validateCredentials() {
    const requiredKeys = ['auth', 'uid', 'psign', 'token'];
    const isValid = requiredKeys.every(k => this.cfg[k]);
    
    if (!isValid) {
      $notification.post("ğŸ”‘ å‡­è¯ç¼ºå¤±", "è¯·å…ˆåœ¨APPå®Œæˆä¸€æ¬¡æ‰‹åŠ¨æ“ä½œ", "");
      return false;
    }
    return true;
  },

  // æ‰§è¡Œç­¾åˆ°
  async performSignIn() {
    const response = await $http.post({
      url: `${this.base}claimCapacity?${this.buildQueryString()}`,
      headers: this.buildHeaders()
    });
    
    if (response.data?.errCode !== "0") {
      throw new Error(`ç­¾åˆ°å¤±è´¥: ${response.data?.errMsg || 'æœªçŸ¥é”™è¯¯'}`);
    }
    
    return {
      capacity: this.formatCapacity(response.data.data?.dataSpaceTaskInfos)
    };
  },

  // è·å–å­˜å‚¨ä¿¡æ¯
  async fetchSpaceInfo() {
    const response = await $http.get({
      url: `${this.base}getStorageSpace?${this.buildQueryString()}`,
      headers: this.buildHeaders()
    });
    
    return this.formatSpaceInfo(response.data?.data);
  },

  // æ„å»ºæŸ¥è¯¢å‚æ•°
  buildQueryString() {
    return `psign=${this.cfg.psign}&authCode=${this.cfg.auth}&userId=${this.cfg.uid}&p_appVersion=7.8.9`;
  },

  // æ„å»ºè¯·æ±‚å¤´
  buildHeaders() {
    return {
      "Cookie": `authCode=${this.cfg.auth}; token=${this.cfg.token}`,
      "User-Agent": "OutdoorAssistant/7.8.9 (2bulu.plugin)",
      "X-Requested-With": "XMLHttpRequest"
    };
  },

  // æ ¼å¼åŒ–å®¹é‡ä¿¡æ¯
  formatCapacity(tasks = []) {
    const targetTask = tasks.find(t => t.type === 0);
    return targetTask ? 
      `${(targetTask.capacity / 1048576).toFixed(1)} MB` : 
      "å®¹é‡æ•°æ®å¼‚å¸¸";
  },

  // æ ¼å¼åŒ–å­˜å‚¨ä¿¡æ¯
  formatSpaceInfo(data = {}) {
    return {
      total: `${(data.sumCapacity / 1073741824).toFixed(2)} GB`,
      used: `${(data.useCapacity / 1073741824).toFixed(2)} GB`,
      pendingTasks: data.dataSpaceTaskInfos?.filter(t => t.status === 0).length || 0
    };
  },

  // å‘é€é€šçŸ¥
  sendNotification(signResult, spaceInfo) {
    $notification.post(
      "ğŸ“¦ äº‘ç©ºé—´æŠ¥å‘Š", 
      `æœ¬æ¬¡è·å¾—ï¼š${signResult.capacity}\nå­˜å‚¨çŠ¶æ€ï¼š${spaceInfo.used} å·²ç”¨ / ${spaceInfo.total} æ€»é‡`,
      `å¾…é¢†å–ä»»åŠ¡ï¼š${spaceInfo.pendingTasks} ä¸ª | æ’ä»¶ç‰ˆæœ¬ï¼šv2.1`
    );
  }
};

// æ‰§è¡Œä¸»ç¨‹åº
_2bulu.execute();